#!/bin/sh
set -e
. /usr/share/debconf/confmodule

save_logs () {
	save_to="$1"

	dir="$save_to/install" # dir name under 8 letters in case FS is fat
	c=1
	if [ -d "$dir" ]; then
		c=$(expr $c + 1)
		dir="$save_to/install.$c"
	fi
	mkdir "$dir"
	
	for file in \
	    /etc/lsb-release \
	    /var/log/messages \
	    /var/log/syslog \
	    /var/log/partman \
	    /var/lib/dpkg/status \
	    /var/log/hardware-summary \
	    /var/log/package-versions \
	    /usr/share/save-logs/install-report.template; do 
	    	if [ -e "$file" ]; then
			if ! cp "$file" "$dir"; then
				db_progress STOP
				exit 1
			fi
		fi
    	done
}

db_input critical save-logs/menu || true
db_go || true
db_get save-logs/menu
METHOD="$RET"

db_progress START 0 2 debian-installer/save-logs/title
report-hw > /var/log/hardware-summary
db_progress STEP 1

case "$METHOD" in
web)
	# The httpd serves files from /var/log, where almost
	# everything of interest is. Link a few other useful files to
	# there.
	ln -sf /etc/lsb-release /var/log
	ln -sf /var/lib/dpkg/status /var/log
	ln -sf /usr/share/save-logs/install-report.template /var/log
	# TODO: avoid running more than one
	httpd
		
	db_progress STEP 1
	db_progress STOP
	if [ -z "$(grep : /proc/net/dev | grep -v lo:)" ]; then
		db_input critical save-logs/no_network || true
	else
		IPADDR=$(ifconfig | grep 'inet addr:' | head -1 | \
			sed 's/.*inet addr:\([0-9.]*\).*/\1/')
		db_subst save-logs/httpd_running ADDRESS "$IPADDR"
		db_input critical save-logs/httpd_running || true
	fi
	db_go || true
;;
"mounted filesystem")
	if [ -e "/hd-media" ]; then
		db_set save-logs/directory "/hd-media"
	fi
	db_input critical save-logs/directory || true
	db_go || true
	db_get save-logs/mount-point
	if [ ! -d "$RET" ]; then
		db_subst save-logs/bad_directory DIR "$RET"
		db_input critical save-logs/bad_directory || true
		db_go || true
		db_progress STOP
	else
		save_logs "$RET"
		db_progress STEP 1
		db_progress STOP
	fi
;;
floppy)
	test -d /floppy || mkdir /floppy
	umount /floppy 2>/dev/null || true

	db_input critical save-logs/insert_floppy || [ $? -eq 30 ]
	db_go

	if mountfloppy ; then
		save_logs /floppy
		umount /floppy
		db_progress STEP 1
		db_progress STOP
	else
		db_progress STEP 1
		db_progress STOP
		db_input critical save-logs/floppy_mount_failed || [ $? -eq 30 ]
		db_go
	fi
;;
esac
