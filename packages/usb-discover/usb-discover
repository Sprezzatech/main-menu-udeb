#!/bin/sh

# Probe and setup USB 
if [ -e /proc/bus/pci/devices ]; then

	OHCI=no
	UHCI=no

	# Probe for OHCI first
	while read REPLY ; do 
	if  grep -q $REPLY /proc/bus/pci/devices ; then
		OHCI=yes
	fi
	done <  /usr/lib/usb-discover/ohci-pci.lst 

	while read REPLY ; do 
		if  grep -q $REPLY /proc/bus/pci/devices ; then
			UHCI=yes
		fi
	done  <  /usr/lib/usb-discover/uhci-pci.lst 

	kver=`uname -r | cut -d. -f1,2` # Kernel version (e.g. 2.4)
	
	if [ "$OHCI" = yes ] ; then
		if [ "$kver" = 2.6 ]; then
			modprobe ohci-hcd
		else
			modprobe usb-ohci
		fi
	fi
	if [ "$UHCI" = yes ] ; then
		if [ "$kver" = 2.6 ]; then
			modprobe uhci-hcd
		else
			modprobe usb-uhci
		fi
	fi

	# TODO ehci?

	if [ "$kver" = 2.6 ]; then
		modprobe usbkbd || true
		modprobe hid || true
	else
		modprobe usbkbd  || true
		modprobe keybdev || true 
	fi
	modprobe usbserial || true
fi
