path=$(mktemp -t oldsys-preseed-tests.XXXXXX -d)
mkdir -p $path/mnt $path/defaults
(cd $path ; tar -xzf $TEST_DIR/thecus_static_not_default.tgz > /dev/null 2>&1)
if [ -e $path/mnt/default.tar.gz ]; then
	(cd $path/defaults && tar -xzf $path/mnt/default.tar.gz)
	if [ -e $path/defaults/app/etc/HOSTNAME ]; then
		DEFAULT_HOSTNAME=$(cut -d . -f 1 $path/defaults/app/etc/HOSTNAME)
		DEFAULT_DOMAIN=$(cut -d . -f 2- $path/defaults/app/etc/HOSTNAME)
	fi
	if [ -e $path/defaults/app/cfg/cfg_nic0 ]; then
		parse_ifconfig $path/defaults/app/cfg/cfg_nic0
		[ -n "$IPADDRESS" ] && DEFAULT_IPADDRESS=$IPADDRESS
		unset IPADDRESS NETMASK GATEWAY
	fi
fi
parse_unix_tree $path/mnt
NET_CONFIG=static
parse_ifconfig $path/mnt/cfg/cfg_nic0
# Use DHCP if the original IP from the firmware has never been changed
if [ "$IPADDRESS" = "$DEFAULT_IPADDRESS" -o "$IPADDRESS" = "192.168.1.100" ]; then
	unset NET_CONFIG
	IPADDRESS=192.168.1.100
	unset NETMASK GATEWAY
fi
HOSTNAME=$(cut -d . -f 1 $path/mnt/etc/HOSTNAME)
DOMAIN=$(cut -d . -f 2- $path/mnt/etc/HOSTNAME)
unset_matching_var "HOSTNAME" "$DEFAULT_HOSTNAME"
unset_matching_var "DOMAIN" "$DEFAULT_DOMAIN"
rm -rf $path/mnt
rm -rf $path/defaults
rmdir $path || true
