#! /bin/sh

set -e

ISO3166TAB=/usr/share/iso-codes/iso_3166.tab
SUPPORTED=/usr/share/i18n/SUPPORTED

rm -rf debian/short-tmp
rm -rf debian/locales
mkdir debian/short-tmp
mkdir debian/locales

for file in debian/po/*.po en.po; do
  lang_variant=`basename $file .po`
  lang=$(echo "$lang_variant" | sed -e 's/_.*$//')
  tabfile=debian/short-tmp/$lang_variant.tab
  # create TAB file for this language
  # Only if iso-codes have some translations
  if [ -f debian/iso-codes/$lang_variant.po ] ; then
    msgconv debian/iso-codes/$lang_variant.po -t UTF-8 --stringtable-output | tail -n +3 | \
      sed -e 's/" = "/	/' -e 's/^"//' -e 's/";$//' | awk '/^.+$/{print}'> $tabfile
  fi
  outfile=debian/short-tmp/$lang_variant.short
  lastlocale=C
  :> $outfile
  for locale in $( (grep -e "^$lang" $SUPPORTED || true) | sed -e 's/[@. ].*//' | sort | uniq); do
      code=`echo "$locale" | sed -e 's/.*_//'`
      line=$(grep -e "^$code" $ISO3166TAB || true)
      lastlocale=$locale
      if [ "$line" ]; then
         OLD_IFS="$IFS"
	 IFS='	'
	 set $line
	 IFS="$OLD_IFS"
	 if [ "$2" ]; then
	   translation=$( (grep "^$2	" $tabfile || true) | sed -e 's/^.*	//')
	   if [ "$translation" ]; then
	      echo -e "$1\t$translation" >> $outfile
	   else
	      echo -e "$1\t$2" >> $outfile
	   fi
	 fi
      fi
   done
   if [ $(wc -l < $outfile) -le 1 ]; then
      rm -f $outfile
   else
      localedef -c -f UTF-8 -i $lastlocale debian/locales/$lastlocale.UTF-8
      LOCPATH=`pwd` LC_ALL=debian/locales/$lastlocale.UTF-8 sort -k 2.1 $outfile > $outfile.tmp && mv $outfile.tmp $outfile
   fi
done

# make one file from parts

SHORTLISTS=debian/short-tmp/shortlists
:>$SHORTLISTS

for file in debian/short-tmp/*.short; do
   lang=`basename $file .short`
   echo -n "$lang" >> $SHORTLISTS
   ( while read line; do
         echo -en "\t$line" >> $SHORTLISTS
     done
   ) < $file
   echo "" >> $SHORTLISTS
done
