#!/bin/sh
#
# Prepare to run base-config after reboot
set -e

# Only here for stable installs (ie, skolelinux)
. /usr/share/debconf/confmodule
if db_get mirror/suite && [ "$RET" ] ; then
    SUITE="$RET"
fi
(
    echo "# inserted by prebaseconfig"
    echo "SUITE=\"$SUITE\""
) >> /target/root/dbootstrap_settings

console=$(chroot /target tty | sed 's/\/dev\///g')

case "$console" in
ttyS*)
    ttyspeed=$(chroot /target stty speed)
    ttyline=$(echo "$console" | sed 's/^ttyS//')
    ttyterm="$TERM"

    if [ -z "$ttyterm" ]; then ttyterm=vt100; fi
    if [ -z "$ttyspeed" ]; then ttyspeed=9600; fi
    cat /target/etc/inittab | sed \
        -e "s/^\([1-6]\):/#\1:/" \
	-e "s/^#T0\(.*ttyS\).*/T$ttyline\1$ttyline $ttyspeed $ttyterm/" \
            > /target/etc/inittab.real
    echo "# $console added by debian-installer" >> /target/etc/securetty
    echo "$console" >> /target/etc/securetty
;;
*)
    # graphical console, leave inittab alone
    mv /target/etc/inittab /target/etc/inittab.real
;;
esac

cp /usr/share/prebaseconfig/inittab /target/etc/inittab
