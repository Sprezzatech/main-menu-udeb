#!/bin/sh
#
# Prepare to run base-config after reboot
set -e

# Only here for stable installs (ie, skolelinux)
. /usr/share/debconf/confmodule
if db_get mirror/suite && [ "$RET" ] ; then
    SUITE="$RET"
fi
(
    echo "# inserted by prebaseconfig"
    echo "SUITE=\"$SUITE\""
) >> /target/root/dbootstrap_settings

# Since this script is running with debconf, 'tty' does
# not give reliable answers about what sort of terminal
# we have.  The stdin of /sbin/debian-installer seems
# to tell the truth.
console_=$(readlink /proc/$(pidof debian-installer)/fd/0)
console=$(mapdevfs "$console_")
console_=${console_#/dev/}
console=${console#/dev/}

case "$console" in
ttyS*)
    ttyspeed=$(chroot /target stty --file /dev/$console speed)
    ttyline=${console#ttyS}
    ttyterm="$TERM"

    if [ -z "$ttyterm" ]; then ttyterm=vt100; fi
    if [ -z "$ttyspeed" ]; then ttyspeed=9600; fi
    sed -e "s/^\([1-6]\):/#\1:/" \
	-e "s/^#T0\(.*ttyS\).*/T$ttyline\1$ttyline $ttyspeed $ttyterm/" \
            /target/etc/inittab > /target/etc/inittab.real
    echo "# serial console added by debian-installer" >> /target/etc/securetty
    echo "$console_" >> /target/etc/securetty
    if [ -n "$console" ] && [ "$console" != "$console_" ]; then
	echo "$console" >> /target/etc/securetty
    fi

    sed -e "s/^\([23]\):#\1:/" \
        -e "s#CONSOLEDEV#/dev/$console#g" \
	/usr/share/prebaseconfig/inittab > /target/etc/inittab
;;
*)
    mv /target/etc/inittab /target/etc/inittab.real
    sed -e "s#CONSOLEDEV#/dev/$console#g" /usr/share/prebaseconfig/inittab \
        > /target/etc/inittab
;;
esac


