#! /bin/sh -e

HANDLERS=handlers
SPOOL="$(mktemp -d)"

trap 'rm -rf "$SPOOL"' EXIT HUP INT QUIT TERM

. kickseed.sh

ks_preseed () {
	echo "$@" >> "$SPOOL/test-output"
}

ks_run_script () {
	TYPE="$1"
	INTERPRETER="$2"
	CHROOTED="$3"
	SCRIPT="$4"

	echo "Would run $TYPE script $SCRIPT using interpreter $INTERPRETER (chrooted: $CHROOTED):"
	cat "$SCRIPT"
	echo
}

RET=0
(kickseed "$1") || RET=$?

sort "$SPOOL/test-output"

echo
# TODO: sort numerically
for script in "$SPOOL/post"/*.script; do
	CHROOTED=0
	if [ -e "${script%.script}.chroot" ]; then
		CHROOTED=1
	fi
	ks_run_script post /bin/sh "$CHROOTED" "$script"
done

exit $RET
