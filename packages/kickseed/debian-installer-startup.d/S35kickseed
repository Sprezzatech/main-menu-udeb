#! /bin/sh -e

. /usr/share/debconf/confmodule

HANDLERS=/lib/kickseed/handlers
SPOOL=/var/spool/kickseed

. /lib/kickseed/kickseed.sh
. /lib/preseed/preseed.sh

ks_preseed () {
	echo "$@" >> "$SPOOL/preseed.cfg"
}

# No support for chrooting here, as /target isn't available yet and %pre
# scripts don't need it.
ks_run_script () {
	TYPE="$1"
	INTERPRETER="$2"
	SCRIPT="$4"

	logger -t kickseed "Running $TYPE script $SCRIPT using interpreter $INTERPRETER:"
	"$INTERPRETER" "$SCRIPT"
}

preseed_fetch () {
	ln -sf "$1" "$2"
}

preseed_relative () {
	if [ -z "${1##/*}" ]; then
		return 1
	else
		return 0
	fi
}

KSCFG=

for item in $(cat /proc/cmdline); do
	var="${item%%=*}"

	if [ "$var" != ks ]; then
		continue
	fi

	value="${item#*=}"
	# TODO: only works for files in the initrd so far
	case $value in
		file:*)
			KSCFG="${value#file:}"
			;;
		*)
			logger -t kickseed "Kickstart location $value not supported"
			;;
	esac
	break
done

if [ "$KSCFG" ]; then
	logger -t kickseed "Reading kickstart file from $KSCFG"

	kickseed "$KSCFG"

	if [ -s "$SPOOL/preseed.cfg" ]; then
		preseed_location "$SPOOL/preseed.cfg"
	fi
fi
