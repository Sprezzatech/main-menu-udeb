#!/bin/sh
. /usr/share/debconf/confmodule

FLOPPYMNT=/floppy

ask_dev() {
	DEVS=""
	for dev in $(list-devices floppy); do
		# TODO if sfdisk or something similar were available, we could
		# do this:
		#        SIZE=sfdisk -s $DEV
		#        if [ "$SIZE" -eq '1440' -o "$SIZE" -eq '2880' ]; then
		if [ -b "$dev" ]; then
			if [ -z "$DEVS" ]; then
				DEVS="$dev"
			else
				DEVS="$DEVS, $dev"
			fi
		fi
	done
	db_subst retriever/floppy/device DEVS $DEVS
	db_input high retriever/floppy/device
	db_go 
	db_get retriever/floppy/device
	if [ "$RET" = Cancel ]; then
		exit 1
	fi
	echo $RET
}

try_mount() {
	# TO REMOVE, there is a bug somewhere in the kernel, the first
	# mount command fail when changing floppy disk
	# so we have to launch mount twice
	mount $1 -tauto $2 || true
	umount $2 || true
	mount $1 -tauto $2
}

if ! mount | cut -d' ' -f3 | grep -q "^$FLOPPYMNT$"; then
	# This is a good reasonable default, but will fail for
	# USB floppys.
	FLOPPYDEV=/dev/fd0
	
	if [ ! -e $FLOPPYDEV ]; then
		log-output -t mountfloppy modprobe -q floppy || true
		update-dev
	fi

	if ! grep -q ^vfat /proc/modules ; then
		log-output -t mountfloppy modprobe -q vfat || true
	fi
	
	# Cannot find a device, or found the wrong device.
	if [ ! -e "$FLOPPYDEV" ] || ! try_mount $FLOPPYDEV $FLOPPYMNT; then
		# Maybe the system has an ide-floppy device?
		log-output -t mountfloppy modprobe -q ide-floppy || true
		update-dev

		# Ask for help from the user and try it again.
		FLOPPYDEV=$(ask_dev)
		try_mount $FLOPPYDEV $FLOPPYMNT
	fi
fi
