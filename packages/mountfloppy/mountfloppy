#!/bin/sh

if [ "$1" = driver ]; then
	WANTDRIVER=1
fi

FLOPPYMNT=/floppy

try_mount() {
	# TO REMOVE, there is a bug somewhere in the kernel, the first
	# mount command fail when changing floppy disk
	# so we have to launch mount twice
	mount $1 -tauto $2 || true
	umount $2 || true
	mount $1 -tauto $2

	if [ "$WANTDRIVER" ]; then
		# Make sure this is a driver floppy by checking the files on
		# it. Check for regular debs, udebs, and to be on the safe
		# side, check for *.ude files (msdos file names...)
		for filename in $2/*.deb $2/*.udeb $2/*.ude; do
			if [ -f "$filename" ]; then
				return 0 # success
			fi
		done
		umount $2
		return 1
	else
		return 0 
	fi
}

if ! mount | cut -d' ' -f3 | grep -q "^$FLOPPYMNT$"; then
	# This is a good reasonable default, but will fail for
	# USB floppys.
	FLOPPYDEV=/dev/fd0
	
	if [ ! -e $FLOPPYDEV ]; then
		log-output -t mountfloppy modprobe -q floppy || true
		update-dev
	fi

	if ! grep -q ^vfat /proc/modules ; then
		log-output -t mountfloppy modprobe -q vfat || true
	fi
	
	# Cannot find a device, or found the wrong device.
	if [ ! -e "$FLOPPYDEV" ] || ! try_mount $FLOPPYDEV $FLOPPYMNT; then
		# Maybe the system has an ide-floppy device?
		log-output -t mountfloppy modprobe -q ide-floppy || true
		update-dev
		try_mount $FLOPPYDEV $FLOPPYMNT
	fi
fi
