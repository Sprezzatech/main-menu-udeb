#!/bin/sh
set -e

. /usr/share/debconf/confmodule

fetch() {
	url="$1"
	file="$2"
	iters=0
	while [ $iters -lt 3 ]; do
		# TODO proxy support? Would it be useful?
		if wget -q "$url" -O "$file"; then
			return 0
		fi
        	iters=$(($iters + 1))
	done
	return 1
}

db_get preseed/url
url="$RET"
if [ -n "$url" ]; then
	if ! fetch $url /tmp/preseed; then
		db_subst preseed/download_error URL "$url"
		db_input critical preseed/download_error || true
		db_go || true
		exit 10
	fi
fi

debconf-set-selections /tmp/preseed
