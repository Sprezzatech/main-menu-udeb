#!/bin/sh

set -e

# Script for generating a debconf templates file from both files
# in debian/po/*.po and country names translations from the
# iso-codes package

# Translations location (relative to the build root directory)
ISO3166TRANSLATIONS=debian/iso-codes

if [ -z "$DEB_HOST_ARCH" ]; then
    DEB_HOST_ARCH="$(dpkg-architecture -qDEB_HOST_ARCH)"
fi

# Get the ordered list of countries from the iso_3166.xml, sorted
# according to the regionmap.
#
# We need to escape commas by preceding them with a backslash.
HTTPCODECHOICES=`cat debian/httplist-countries`
FTPCODECHOICES=`cat debian/ftplist-countries`

printf "Creating the list of countries for HTTP mirrors..."
HTTPCHOICES="$(xargs < debian/httplist-countries | sed 's/ /, /g')"
printf " Done.\n"

printf "Creating the list of countries for FTP mirrors..."
FTPCHOICES="$(xargs < debian/ftplist-countries | sed 's/ /, /g')"
printf " Done.\n"

printf "Insert the lists of choices into the templates file..."
# Now put this list as the choices in the templates
# and defined this field as translatable (__Choices hack)
(
	for t in $@; do
		cat $t
		echo
	done
) | debian/templates-build.pl "$DEB_HOST_ARCH" | \
    perl -pe 'if (m,http/countries$,) { $found = 1; } elsif ($found and /(?:enter information manually|manual)$/ && length "'"$HTTPCHOICES"'") { s/$/, '"$HTTPCHOICES"'/; $found = 0 if (m,^_Choices:,); }' | \
    perl -pe 'if (m,ftp/countries$,) { $found = 1; } elsif ($found and /(?:enter information manually|manual)$/ && length "'"$FTPCHOICES"'") { s/$/, '"$FTPCHOICES"'/;  $found = 0 if (m,^_Choices:,); }' | \
    sed "/^_Choices: enter/s/_Choices:/__Choices:/g" \
    >debian/templates.tmp
printf " Done.\n"

# Create temporary "pobuild" directories
rm -rf debian/pobuild* >/dev/null 2>&1
mkdir debian/pobuild.en debian/pobuild

# Create the appropriate POTFILES.in file there
cat >debian/pobuild.en/POTFILES.in <<EOF
[type: gettext/rfc822deb] templates.tmp
EOF
cat >debian/pobuild/POTFILES.in <<EOF
[type: gettext/rfc822deb] templates2.tmp
EOF

# Create the appropriate output file also
cat >debian/pobuild.en/output <<EOF
2   utf8
EOF
cat >debian/pobuild/output <<EOF
2   utf8
EOF

# Run debconf-updatepo to create pobuild.en/templates.pot
debconf-updatepo --podir debian/pobuild.en

printf "Add English country names to country selection templates..."
./map-cc < "$ISO3166TRANSLATIONS/en.po" > debian/pobuild.en/en.po
msgmerge -U debian/pobuild.en/en.po debian/pobuild.en/templates.pot 2>/dev/null
printf " Done.\n"

PODEBCONF_LIB=. po2debconf --podir debian/pobuild.en debian/templates.tmp \
    >debian/pobuild.en/templates.tmp

# Replace the Choices: field in debian/templates.tmp with the "translated"
# Choices-en.UTF-8 field from debian/pobuild.en/templates.tmp; ensure we preserve
# escaped commas
EN_HTTP="$(perl -ne 'if (m,http/countries$,) { $found = 1; } elsif ($found and /^Choices-en.UTF-8:/) { s/^Choices.*: //; s/\\,/\\\\,/g; print; $found = 0; }' debian/pobuild.en/templates.tmp)"
EN_FTP="$(perl -ne 'if (m,ftp/countries$,) { $found = 1; } elsif ($http and /^Choices-en.UTF-8:/) { s/^Choices.*: //; s/\\,/\\\\,/g; print; $found = 0; }' debian/pobuild.en/templates.tmp)"

cat debian/templates.tmp | \
    perl -pe 'if (m,http/countries$,) { $found = 1; } elsif ($found and /Choices:/ && length "'"$EN_HTTP"'") { s/: .*$/: '"$EN_HTTP"'/; $found = 0; }' | \
    perl -pe 'if (m,ftp/countries$,) { $found = 1; } elsif ($found and /Choices:/ && length "'"$EN_FTP"'") { s/: .*$/: '"$EN_FTP"'/; $found = 0; }' \
    >debian/templates2.tmp

# Now run debconf-updatepo to create pobuild/templates.pot
debconf-updatepo --podir debian/pobuild

printf "Include country names translations into the templates file:\n"
# The following takes place for each language
# (each existing file in debian/po)
for pofile in debian/po/*.po ; do
    pofilename=`basename $pofile`
    langname=`basename $pofilename .po`
    printf "  $langname..."

    cp $pofile debian/pobuild/$pofilename.d-i
    # update with generated templates.pot
    msgmerge -U debian/pobuild/$pofilename.d-i \
		debian/pobuild/templates.pot 2>/dev/null
    if [ -f $ISO3166TRANSLATIONS/$pofilename ]; then
        # ensure iso-codes translations are in UTF-8
	msgconv -t UTF-8 "$ISO3166TRANSLATIONS/$pofilename" \
		> debian/pobuild/$pofilename.iso-codes
        # merge with iso-codes translations
	msgmerge debian/pobuild/$pofilename.iso-codes \
		 debian/pobuild/$pofilename.d-i \
		 > debian/pobuild/$pofilename 2>/dev/null
        # clean out the generated file
	msgmerge -U debian/pobuild/$pofilename \
		    debian/pobuild/templates.pot 2>/dev/null
    else
	cp debian/pobuild/$pofilename.d-i debian/pobuild/$pofilename
    fi
    printf " done\n"
done

# and now we generate the templates file from all this
PODEBCONF_LIB=. po2debconf --podir debian/pobuild debian/templates2.tmp | \
    sed "s/\[ Default value for .*\]//" \
    >debian/choose-mirror-bin.templates

# give the new templates file the same mtime as the input file, so that
# po2debconf doesn't decide that it needs to run debconf-updatepo
touch -mr debian/choose-mirror-bin.templates-in debian/choose-mirror-bin.templates

rm -f debian/templates.tmp debian/templates2.tmp
