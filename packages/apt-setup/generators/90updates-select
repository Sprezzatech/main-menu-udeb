#!/bin/sh
set -e

. /usr/share/debconf/confmodule

if ! db_get mirror/suite || [ -z "$RET" ]; then
	db_get cdrom/suite
fi
suite="$RET"

updates=""
if db_get apt-setup/security_host && [ "$RET" ] && \
   [ "$suite" != unstable ]; then
	updates=${updates:+$updates, }security
fi

volatile=n
# Disable volatile for now as we first need its GPG key in the keyring
# To activate: uncomment next lines and update log messages below
#if db_get apt-setup/volatile_host && [ "$RET" ] && \
#   ([ "$suite" = stable ] || [ "$suite" = oldstable ]); then
#	updates=${updates:+$updates, }volatile
#	volatile=y
#fi

db_set apt-setup/updates-select $updates

# Nothing available so skip the question
if [ -z "$updates" ]; then
	exit
fi

db_input medium apt-setup/updates-select
if ! db_go; then
	exit 10 # back up
fi

# Selecting volatile for testing is invalid
db_get apt-setup/updates-select
updates="$RET"
if [ "$volatile" = n ] && echo "$updates" | grep -q volatile; then
	new_updates=""
	for u in $(echo $updates | sed "s/,/ /"); do
		if [ "$u" != volatile ]; then
			new_updates=${new_updates:+$new_updates, }$u
		fi
	done
	#logger -t apt-setup "info: invalid selection of volatile for testing disabled"
	logger -t apt-setup "info: GPG key for volatile is not yet available; selection disabled"
	db_set apt-setup/updates-select $new_updates
fi

# Proxy configuration is common to both security and volatile
if db_get mirror/http/proxy && [ -n "$RET" ]; then
	proxy="$RET"
	if ! grep -iq "Acquire::http::Proxy" $ROOT/etc/apt/apt.conf.new; then
		echo "Acquire::http::Proxy \"$proxy\";" >> $ROOT/etc/apt/apt.conf.new
	fi
fi
