#!/bin/sh
set -e

. /usr/share/debconf/confmodule

file="$1"

# unmount CD so apt-cdrom can access it. Remount at end if it was mounted.
CDDEV=$(mount | grep "on /cdrom" | cut -d ' ' -f 1)
if [ -n "$CDDEV" ]; then
	umount /cdrom || true
fi
cleanup () {
	if [ -n "$CDDEV" ]; then
		mount -t iso9660 -o ro,exec $CDDEV /cdrom || true
	fi
}
trap cleanup EXIT

if [ -n "$ROOT" ]; then
        chroot=chroot
else
        chroot=
fi

tmp=$($chroot $ROOT tempfile)
# apt-cdrom can be interactive, avoid that
$chroot $ROOT apt-cdrom add \
	-o Dir::Etc::SourceList=$tmp \
	-o Acquire::gpgv::Options::=--ignore-time-conflict \
	</dev/null
cat $ROOT$tmp >> $file
rm -f $ROOT$tmp $ROOT$tmp~
