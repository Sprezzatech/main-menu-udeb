#!/usr/bin/perl
# Given a partial templates file on stdin which can contain some
# existing templates for countries, generates a complete templates file on
# stdout for all countries listed in the zone.tab. Also writes out the
# tzmap file, and uses tzmap.override to force countries that have only one
# zone. See README for details.

use warnings;
use strict;

print "# This file was generated automatically, edit its source file instead\n";

sub honking_big_comment {
	my ($cc, $englist)=@_;
	return <<"EOF"
# Timezones for $cc.
# 
# TRANSLATORS PLEASE NOTE: The msgid below looks strange because it is
# a list of filenames (in /usr/share/zoneinfo). Do not translate the filenames.
# Instead translate the English text which is displayed to the user instead
# of these filenames. Also, many place names will not need translation
# from the English text, but some parts may be translatable.
#
# The English text to translate for this list of timezones is:
# $englist
EOF
}

my %seencc;
{
	local $/="\n\n";
	while (<>) {
		if (m!Template: tzsetup/country/([A-Z]+)!) {
			my $cc=$1;
			$seencc{$cc}=1;
			if (m/Choices-en.UTF-8: (.*)$/m) {
				my $enchoices=$1;
				s/(_Choices:)/honking_big_comment($cc,$enchoices).$1/me;
			}
		}
		print;
	}
}

my $zonetab="/usr/share/zoneinfo/zone.tab";
my %cc2zone;
my %zonedesc;
open (IN, $zonetab) || die "$zonetab: $!";
while (<IN>) {
	chomp;
	next if /#/;
	next unless length;
	my ($cc, $coord, $zone, $comments)=split(' ', $_, 4);
	push @{$cc2zone{$cc}}, $zone unless $seencc{$cc};
	if (defined $comments) {
		$comments=~s/,/\\,/g; # escape for choices list
		$zonedesc{$zone}="$zone ($comments)"; 
	}
	else {
		$zonedesc{$zone}=$zone;
	}
}
close IN;

my %override;
open (OVERRIDE, "tzmap.override") || die "tzmap.override: $!";
while (<OVERRIDE>) {
	chomp;
	next if /^#/;
	my ($cc, $zone)=split(' ', $_, 2);
	$override{$cc}=1;
	$cc2zone{$cc}=[$zone];
}
close OVERRIDE;

open (TZMAP, ">tzmap") || die "tzmap: $!";
foreach my $cc (sort keys %cc2zone) {
	my $list=join(", ", @{$cc2zone{$cc}});
	if (@{$cc2zone{$cc}} > 1 && ! $override{$cc}) {
		my $englist=join(", ", map { $zonedesc{$_} } @{$cc2zone{$cc}});
		print STDERR "warning: autogenerated template for $cc should be manually reviewed\n";
		print "\nTemplate: tzsetup/country/$cc\n";
		print "Type: select\n";
		print honking_big_comment($cc, $englist);
		print "_Choices: $list\n";
		print "Choices-en.UTF-8: $englist\n";
		print "_Description: Select your time zone:\n";
	}
	else {
		print TZMAP "$cc $list\n";
	}
}
close TZMAP;
