#!/bin/sh
set -e

create () {
	if [ ! -e $1 ]; then
		echo "# Local module settings" > $1
		echo "# Created by the Debian installer" >> $1
		echo "" >> $1
	fi
}

# Avoid the following kernel message:
# Warning! ehci_hcd should always be loaded before uhci_hcd and ohci_hcd, not after
FILE=/target/etc/modprobe.d/local.conf
if lsmod | grep -q "^ehci_hcd[[:space:]]"; then
	modules=$(lsmod | sed -n "/^[ou]hci_hcd[[:space:]]/ {s/[[:space:]].*//; p}")
	for module in $modules; do
		if [ -f "$FILE" ] && \
		   grep -q "^install $module " "$FILE"; then
			continue
		fi

		create $FILE
		cat <<EOF >>$FILE
# Ensure ehci_hcd gets loaded before $module
install $module /sbin/modprobe -q ehci_hcd; /sbin/modprobe --ignore-install $module
EOF
	done
fi
