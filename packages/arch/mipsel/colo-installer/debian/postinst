#!/bin/sh
set -e

. /usr/share/debconf/confmodule

log() {
	logger -t lilo-installer "$@"
}

error() {
	log "error: $@"
}

info() {
	log "info: $@"
}

findfs () {
	df /target$1 | sed '1d;s/ .*//'
}

# detect the partitions /target and /target/boot
rootfs_devfs=$(findfs /)
bootfs_devfs=$(findfs /boot)

rootfs=$(mapdevfs $rootfs_devfs)
bootfs=$(mapdevfs $bootfs_devfs)
bootfs_no_dev=${bootfs#/dev/}

if ! apt-install colo ; then
	info "Calling 'apt-install colo' failed"
	db_input critical colo-installer/apt-install-failed || [ $? -eq 30 ]
	if ! db_go; then
		exit 10 # back up to menu
	fi
	db_get colo-installer/apt-install-failed
	if [ true != "$RET" ] ; then
		exit 1
	fi
fi

# find the kernel
if [ "$rootfs" = "$bootfs" ] ; then
	kernel=/vmlinux
else
	kernel=`find /target/boot -name 'vmlinu*cobalt*' | tail -1`
	kernel=${kernel#/target}
fi
info "Using kernel '$kernel'"

cat > /target/boot/default.colo <<EOF
# load the Debian kernel from $bootfs_no_dev
mount $bootfs_no_dev
load $kernel
execute root=$rootfs console=ttyS0,115200
EOF

