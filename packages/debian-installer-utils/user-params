#!/bin/sh
CMDLINE=/proc/cmdline

SEP=""

saveit() {
	if [ "$skipping" ]; then
		return
	elif [ "$var" = "--" ]; then
		inuser=1
		collect=""
	elif [ "$inuser" ]; then
		# BOOT_IMAGE is added by syslinux.
		if [ "$var" = "BOOT_IMAGE" ]; then
			return
		fi
	
		# init is not generally useful to pass on.
		if [ "$var" = init ]; then
			return
		fi

		# brltty settings shouldn't be passed since
		# they are already recorded in /etc/brltty.conf
		if [ "$var" = brltty ]; then
			return
		fi
	
		# Skip debconf variables.
		varnoslash="${var##*/*}"
		if [ "$varnoslash" = "" ]; then
			return
		fi
		
		# Skip module-specific variables.
		varnodot="${var##*.*}"
		if [ "$varnodot" = "" ]; then
			return
		fi
		
		# Skip preseed aliases.
		if [ -e /etc/preseed_aliases ] && \
		   grep -q "^$var[[:space:]]" /etc/preseed_aliases; then
			return
		fi

		if [ -z "$collect" ]; then
			collect="$var=$value"
		else
			collect="$collect$SEP$var=$value"
		fi
	fi
}

OLDIFS="$IFS"
IFS='"'\'' ' # split on quotes and words
for item in $(cat $CMDLINE); do
	IFS="$OLDIFS"
	newvar="${item%=*}"

	itemnoequals="${item##*=*}"
	if [ -n "$itemnoequals" ] && [ "$item" != "--" ]; then
		if [ -z "$value" ]; then
			value="$item"
		else
			# skip multi-word values, assumed to always be
			# debconf params
			skipping=1
		fi
		continue
	fi

	if [ -n "$var" ]; then
		saveit
	fi

	skipping=
	var="$newvar"
	value="${item#*=}"

	IFS='"'\'' '
done

if [ -n "$var" ]; then
	saveit
fi

# Include default parameters.
RET=`debconf-get debian-installer/add-kernel-opts || true`
if [ "$RET" ]; then
        collect="$collect $RET"
fi

IFS="$SEP"
for var in $collect; do
	echo "$var"
done
