#!/bin/sh

# Basically anything can be put in here as long as the conditions in
# which it should be executed are clear enough

set -e
. /lib/chroot-setup.sh
. /usr/share/debconf/confmodule

TEMPLATE_ROOT=base-config-prep

log() {
	logger -t base-config-prep "$@"
}

# Only run if we're installing Sarge
if db_get mirror/codename && [ "$RET" ]; then
	if [ "$RET" != sarge ]; then
		exit 0
	fi
fi

# vmware uses the mptscsih driver; because of driver changes, mkinitrd
# does not pick this up correctly for the 2.6.8 kernel
if lsmod | grep -q "^mptscsih.*1 mptspi"; then
	if db_get base-installer/kernel/image && [ "$RET" ]; then
		kernelver=${RET#kernel-image-*}
		if echo $kernelver | grep -q "2\.6" &&
		   [ -x /target/usr/sbin/mkinitrd ] &&
		   [ -f /target/boot/initrd.img-$kernelver ] ; then
			echo mptscsih >>/target/etc/mkinitrd/modules
			# Regenerate the initrd
			chroot_setup
			chroot /target mkinitrd -o /boot/initrd.img-$kernelver $kernelver
			chroot_cleanup
		fi
	fi
fi
