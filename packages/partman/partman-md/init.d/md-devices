#!/bin/sh

. /lib/partman/definitions.sh

# Create the raid devices
for i in `cat /proc/mdstat|grep ^md|sed -e 's/^\(md.*\) : active \([[:alnum:]]*\).*/\1/'`; do
	NUMBER=`echo ${i}|sed -e "s/^md//"`
	DEVICE="/var/lib/partman/devices/=dev=md=${NUMBER}"
	mkdir ${DEVICE}
	cd ${DEVICE}
	echo "/dev/md/${NUMBER}" > ${DEVICE}/device

	db_metaget partman-md/text/device description
	echo "${RET}" > ${DEVICE}/model

	# Fixme: Find the size from /dev/mdstat
	echo "0" > ${DEVICE}/size
	open_dialog OPEN "/dev/md/${NUMBER}"
	read_line response
	close_dialog
	if [ "$response" = "failed" ]; then
		rm -rf ${DEVICE}
	fi

	open_dialog NEW_LABEL loop
	close_dialog

	open_dialog PARTITIONS
	free_space=''
	while { read_line num id size type fs path name; [ "$id" ]; }; do
	    if [ "$fs" = free ]; then
	        free_space=$id
	        free_size=$size
	    fi
	done
	close_dialog

	if [ "$free_space" ]; then
	    open_dialog NEW_PARTITION primary ext2 $free_space full $free_size
	    read_line num id size type fs path name
	    close_dialog
	fi
done

exit 0
