#!/bin/sh

# Only run the first time.
if [ -f /var/lib/partman/autouse_swap ]; then
	exit 0
fi
[ -d /var/lib/partman ] || mkdir /var/lib/partman
touch /var/lib/partman/autouse_swap

. /lib/partman/definitions.sh

partitions=
for dev in /var/lib/partman/devices/*; do
    [ -d "$dev" ] || continue
    cd $dev
    open_dialog PARTITIONS
    while { read_line num id size type fs path name; [ "$id" ]; }; do
	[ -f $id/detected_filesystem ] || continue
	fs=$(cat $id/detected_filesystem)
	if [ "$fs" = linux-swap ]; then
	    partitions="$partitions $dev,$id"
	fi
    done
    close_dialog
done

for part in $partitions; do
    dev=${part%,*}
    id=${part#*,}
    [ -d $dev/$id ] || continue
    echo keep >$dev/$id/method
    update_partition $dev $id
done

