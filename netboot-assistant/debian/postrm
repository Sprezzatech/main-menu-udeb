#!/bin/sh
# postrm script for di-netboot-assistant

set -e
DL_CACHE=/var/cache/di-netboot-assistant/
STATUS_LIB=/var/lib/di-netboot-assistant
TFTP_ROOT=/var/lib/tftpboot
if [ -f /var/lib/di-netboot-assistant/.old-conf-for-purge ]; then
	. /var/lib/di-netboot-assistant/.old-conf-for-purge
fi

#This function should be kept in sync with function "uninstall_repo" in di-netboot-assistant
uninstall_repo() {
	dist="$1"
	metadatabasename="$(echo $dist | sed -e 's/\.conf$//' )"

	#remove di-netboot-assistant < 0.37 cached files.
	tarfile="$(grep -E "^[[:blank:]]*dl_file=" "$dist" | sed -e 's/^[[:blank:]]*dl_file=//')"
	if [ "$(echo $tarfile | sed -n -e 's/^\(.\).*/\1/p')" = "/" ]; then
		[ -f "$tarfile" ] && rm "$tarfile"
	fi

	expand_dir="$(grep -E "^[[:blank:]]*expand_dir=" "$dist" | sed -e 's/^[[:blank:]]*expand_dir=//')"
	[ "$expand_dir" != "/" -a -d "$expand_dir" ] && rm -Rf "$expand_dir"

	dist_dir="$(echo  "$expand_dir" | sed -e 's,/[^/]\+$,,')"
	rmdir --ignore-fail-on-non-empty "$dist_dir"

	pxemenufragment="$metadatabasename.pxelinux.menu.fragment"
	[ -f "$pxemenufragment" ] && rm "$pxemenufragment"

	pxemenufragment_serial9600="$metadatabasename.pxelinux.menu.serial-9600.fragment"
	[ -f "$pxemenufragment_serial9600" ] && rm "$pxemenufragment_serial9600"

	elilomenufragment="$metadatabasename.elilo.conf.fragment"
	[ -f "$elilomenufragment" ] && rm "$elilomenufragment"

	rm "$dist"
}

#This function should be kept in sync with function "url2filename" in di-netboot-assistant
url2filename() {
	sed -e 's#//\+#/#g' -e 's#[^[:alnum:]@+_~\.-]#_#g'
}

#This function should be kept in sync with function "remove_repocache" in di-netboot-assistant
remove_repocache() {
	local metadatafile
	local base
	local file

	metadatafile="$1"
	base=$(echo $metadatafile | sed -e 's/~~.*$//' )

	for file in $(sed -n -e 's/^[[:blank:]]*dl_file=[[:blank:]]*//p' $metadatafile); do
		rm $RM_VERBOSITY ${base}_"$(echo ${file}| url2filename)"
	done

	#Purge remaing files (MD5SUMS...) if there are no more cached
	#distribution from the same repository.
	if [ ! "$(ls -1 ${base}~~*.meta | grep -v "$metadatafile")" ]; then
		rm $RM_VERBOSITY ${base}_*
	fi

	[ -f $metadatafile ] && rm $metadatafile

}

case "$1" in
    purge)
	if [ -d ${STATUS_LIB} ]; then

		[ -z "$SYSLINUXMENU" ] && SYSLINUXMENU=menu.c32
		for x in $( find ${STATUS_LIB} -type f -name '*.conf' ) ; do
			uninstall_repo "$x"
		done

		for metadatafile in $(find ${DL_CACHE}/ -name "*~~*--*.meta"); do
			remove_repocache "$metadatafile"
		done

		for x in pxelinux.0 elilo.conf elilo.efi README.txt \
			pxelinux.cfg/default pxelinux.cfg/menu.c32 ; do
			if [ -f "$TFTP_ROOT/debian-installer/$x" ]; then
				rm "$TFTP_ROOT/debian-installer/$x" || true
			fi
		done

		for x in debian-installer/pxelinux.cfg debian-installer; do
			rmdir --ignore-fail-on-non-empty "$TFTP_ROOT/$x" || true
		done

		rm /var/lib/di-netboot-assistant/.old-conf-for-purge || true
	fi
    ;;
    remove)
	if [ -f /etc/di-netboot-assistant/di-netboot-assistant.conf ]; then
		dir=/var/lib/di-netboot-assistant
		[ ! -d $libdir ] && mkdir $libdir
		sed -e "1s/^/#BACKUP, to purge our TFT stuff when purged\n/" \
			< /etc/di-netboot-assistant/di-netboot-assistant.conf \
			> $libdir/.old-conf-for-purge
	fi
    ;;
    upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
    ;;

    *)
	echo "postrm called with unknown argument \`$1'" >&2
	exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
