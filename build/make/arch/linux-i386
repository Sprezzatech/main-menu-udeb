
arch-image: $(IMAGE)

# Create a bootable floppy image.
# 1. make a dos filesystem image
# 2. copy over kernel, initrd
# 3. install syslinux
$(IMAGE): $(INITRD) tmp_mount
	-if [ "$(UPX)" ] ; then \
		$(foreach NAME,$(KERNELNAME), \
			$(UPX) -9 $(TEMP)/$(NAME); ) \
	fi

	dd if=/dev/zero of=$@.new bs=$(FLOPPY_SIZE)k count=1
	mkfs.msdos -i deb00001 -n 'Debian Installer' -C $@.new $(FLOPPY_SIZE)

	echo $(NO_KERNEL)

ifndef NO_KERNEL
	$(foreach NAME,$(KERNELNAME), \
	   mcopy -i$@.new $(TEMP)/$(NAME) ::\linux)
endif
	mcopy -i$@.new $(INITRD) ::\initrd.gz
ifndef NO_KERNEL
	# syslinux is used to make the floppy bootable
	todos < boot/i386/syslinux.cfg | mcopy -i$@.new - ::\syslinux.cfg
	syslinux $(SYSLINUX_OPTS) $@.new
endif

	# Finalize the image.
	mv $@.new $@

# Copy files somewhere the CD build scripts can find them
# XXX Will only use the last kernel if there are several
cd_content: $(IMAGE)
	$(foreach NAME,$(KERNELNAME), \
		cp -f $(TEMP)/$(NAME) $(DEST)/$(TYPE)-linux; )
	cp  boot/i386/syslinux.cfg $(DEST)/$(TYPE)-syslinux.cfg

cd_image: cd_content
	mkisofs -r -J -b `basename $(IMAGE)` -o $(TYPE).iso $(DEST)
	mv $(TYPE).iso $(DEST)

