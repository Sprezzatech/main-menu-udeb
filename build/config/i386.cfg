MEDIUM_SUPPORTED = cdrom netboot demo floppy hd-media

# The version of the kernel to use.
KERNELVERSION = 2.4.24-1-386
KERNEL_FLAVOUR = di
KERNELNAME = vmlinuz
KERNELIMAGEVERSION = $(KERNELVERSION)

# May be needed in rare cases.
#SYSLINUX_OPTS = -s

# The beta version of upx in package upx-ucl-beta can be used to make the
# kernel a lot smaller. It shaved 40k off our kernel. That allows us to put
# a lot more on a single floppy.
UPX=/usr/bin/upx-ucl-beta

# The DOS volume id to use for DOS floppys. This is a 32 bit hexidecimal
# number.
DOS_VOLUME_ID = deb00001
# The DOS volume label to use for DOS floppys. This is a 11 character
# string.
DOS_VOLUME_LABEL = "Debian Inst"

BOOTPICS=boot/i386/pics

# The image to use for a syslinux splash screen.
#SPLASH_RLE=nicholson.rle
SPLASH_RLE=klowner.rle

# Create a bootable image.
# 1. make a dos filesystem image
# 2. copy over kernel, initrd
# 3. install syslinux
# 4. compress the image (if requested)
.PHONY: arch_boot
arch_boot:
	[ ! -x "$(UPX)" ] || $(UPX) -9 $(TEMP_KERNEL) || true
	mkfs.msdos -i $(DOS_VOLUME_ID) -n $(DOS_VOLUME_LABEL) -C $(TEMP_BOOT) $(FLOPPY_SIZE)
	# mkfs.msdos gets the mode wrong (bug filed)
	chmod 644 $(TEMP_BOOT)

	mcopy -i$(TEMP_BOOT) $(TEMP_KERNEL) ::linux
	mcopy -i$(TEMP_BOOT) $(TEMP_INITRD) ::initrd.gz

	# generate a disk label
	./makelabel $(DISK_LABEL) $(BUILD_DATE) > $(TEMP)/disk.lbl
	mcopy -i$(TEMP_BOOT) $(TEMP)/disk.lbl ::disk.lbl

	# syslinux is used to make the floppy bootable
	cat boot/i386/syslinux.cfg | todos | mcopy -i$(TEMP_BOOT) - ::syslinux.cfg
	set -e; \
	$(foreach IMG,$(wildcard boot/i386/*.txt), \
		./bootscreen-subst "$(MEDIA_TYPE)" "$(DEBIAN_VERSION)" "$(BUILD_DATE)" \
		       < $(IMG) | mcopy -i$(TEMP_BOOT) - ::`basename $(IMG)`;)
	if [ -n "$(SPLASH_RLE)" ]; then \
		mcopy -i$(TEMP_BOOT) $(BOOTPICS)/$(SPLASH_RLE) ::splash.rle; \
	fi
	syslinux $(SYSLINUX_OPTS) $(TEMP_BOOT)
	$(if $(GZIPPED),gzip -v9f $(TEMP_BOOT))

# Create a non-bootable image.
.PHONY: arch_root
arch_root:
	mkfs.msdos -i $(DOS_VOLUME_ID) -n $(DOS_VOLUME_LABEL) -C $(TEMP_ROOT) $(FLOPPY_SIZE)
	# mkfs.msdos gets the mode wrong (bug filed)
	chmod 644 $(TEMP_ROOT)

	mcopy -i$(TEMP_ROOT) $(TEMP_INITRD) ::initrd.gz

	# generate a disk label
	./makelabel $(DISK_LABEL) $(BUILD_DATE) > $(TEMP)/disk.lbl
	mcopy -i$(TEMP_ROOT) $(TEMP)/disk.lbl ::disk.lbl
	$(if $(GZIPPED),gzip -v9f $(TEMP_ROOT))

# Create syslinux/isolinux help screens for debian-cd to use, and include
# a boot logo too.
.PHONY: arch_debian_cd_info
arch_debian_cd_info:
	rm -f $(TEMP_DEBIAN_CD_INFO)/* || true
	mkdir -p $(TEMP_DEBIAN_CD_INFO)
	$(foreach IMG,$(wildcard boot/i386/*.txt), \
		./bootscreen-subst "$(MEDIA_TYPE)" "$(DEBIAN_VERSION)" "$(BUILD_DATE)" \
		       < $(IMG) > $(TEMP_DEBIAN_CD_INFO)/`basename $(IMG)`;)
	if [ -n "$(SPLASH_RLE)" ]; then \
		cp $(BOOTPICS)/$(SPLASH_RLE) $(TEMP_DEBIAN_CD_INFO)/splash.rle; \
	fi

# Miniature CD image with only boot image on it.
.PHONY: arch_miniiso
arch_miniiso:
	mkdir -p $(CD_IMAGE_TREE)
	ln -f $(TEMP_BOOT) $(CD_IMAGE_TREE)/boot.img
	mkisofs -r -J -b `basename $(TEMP_BOOT)` -o $(TEMP_MINIISO) $(CD_IMAGE_TREE)
