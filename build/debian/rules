#!/usr/bin/make -f

ARCH=$(shell dpkg-architecture -qDEB_BUILD_ARCH)
VERSION=$(shell LC_ALL=C dpkg-parsechangelog | grep ^Version: | cut -d ' ' -f 2)
DATE=$(shell echo $(VERSION) | cut -d '.' -f 1)
DISTRIBUTION=$(shell LC_ALL=C dpkg-parsechangelog | grep ^Distribution: | cut -d ' ' -f 2)
ifeq (${DISTRIBUTION},UNRELEASED)
DISTRIBUTION=unstable
endif

ARCHIVEDIR=installer-$(ARCH)
IMAGEDIR=$(ARCHIVEDIR)/$(DATE)/images
TARNAME=debian-installer-images_$(VERSION)_$(ARCH).tar.gz

# Work out the name(s) of the kernel that the demo deb should depend on.
DEB_HOST_GNU_CPU = $(shell dpkg-architecture -qDEB_HOST_GNU_CPU)
DEB_HOST_GNU_SYSTEM = $(shell dpkg-architecture -qDEB_HOST_GNU_SYSTEM)
include config/main
include config/arch/$(DEB_HOST_GNU_SYSTEM)
include config/arch/$(DEB_HOST_GNU_SYSTEM)-$(DEB_HOST_GNU_CPU)
KERNELPACKAGE=$(shell perl -e 'print join(" | ", @ARGV)' \
              $(foreach KVERS,${KERNELVERSION},kernel-image-$(KVERS)))

clean:
	dh_testdir
	dh_testroot
	$(MAKE) reallyclean
	dh_clean build-stamp

build: build-stamp
build-stamp:
	fakeroot $(MAKE) all_images all_stats SUITE=$(DISTRIBUTION)
	touch build-stamp

install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_install
	install -d debian/tmp/$(IMAGEDIR)
	cp -p dest/* debian/tmp/$(IMAGEDIR)
	cd debian/tmp/$(IMAGEDIR) && md5sum * > MD5SUMS
	ln -s $(DATE) debian/tmp/$(ARCHIVEDIR)/current

binary-arch: install  
	dh_testdir
	dh_testroot
	dh_installchangelogs
	dh_installdocs
	dh_installman debian/d-i-demo.8
	dh_compress
	dh_fixperms -X usr/lib/debian-installer-demo
	dh_gencontrol -- -Vkernel:Package='$(KERNELPACKAGE)'
	dh_builddeb
	cd debian/tmp && tar czvf ../../../$(TARNAME) .
	dpkg-distaddfile $(TARNAME) byhand -

binary-indep:

binary: binary-indep binary-arch 
.PHONY: build clean binary-indep binary-arch binary install 
