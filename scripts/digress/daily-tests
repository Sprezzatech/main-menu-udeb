#!/bin/sh
set -e

MACHINE="$1"
shift 1

if [ -z "$MACHINE" ]; then
	echo "Usage: $0 machine scheme [scheme ...]" >&2
	exit 1
fi

config () {
	var="$1"
	shift 1
	eval "$var='$@'"
}

use () {
	. $DI_TESTDIR/schemes/$MACHINE/$1
}

overview () {
	logdir=$1
	shift 1
	grep -v "$MACHINE-$SCHEME " $LOGDIR/overview.log > $LOGDIR/overview.log.new || true
	LANG=C echo "$ARCH ($(date)) $(whoami)@$(hostname | cut -d . -f 1) $MACHINE-$SCHEME $1" >> $LOGDIR/overview.log.new
	mv $LOGDIR/overview.log.new $LOGDIR/overview.log
}

DIGRESSDIR=$(dirname $0)
cd $DIGRESSDIR
if [ -z "$DI_TESTDIR" ]; then
	DI_TESTDIR=$DIGRESSDIR
fi

if [ -z "$DI_TESTDIR" ] || [ ! -e "$DI_TESTDIR/config" ]; then
	echo "Cannot determine DI_TESTDIR" >&2
	exit 1
fi

datestamp=$(date +%Y%m%d%H%M)
. $DI_TESTDIR/config

for SCHEME in $@; do
	RETRY=""
	LOGDIR=$DI_TESTDIR/logs
	use common
	use $SCHEME
	
	mkdir -p $LOGDIR/$datestamp
	touch $LOGDIR/overview.log

	if $DIGRESSDIR/test-harness $MACHINE $SCHEME > $LOGDIR/$datestamp/$MACHINE-$SCHEME.log 2>&1; then
		overview $LOGDIR success
	else
		if [ -n "$RETRY" ]; then
			if $DIGRESSDIR/test-harness $MACHINE $SCHEME >> $LOGDIR/$datestamp/$MACHINE-$SCHEME.log 2>&1; then
				overview $LOGDIR "success second try"
			else
				overview $LOGDIR failed
			fi
		else
			overview $LOGDIR failed
		fi
	fi
	ln -f $LOGDIR/$datestamp/$MACHINE-$SCHEME.log $LOGDIR/$MACHINE-$SCHEME.log
done
