#!/usr/bin/perl
# Expect script to handle a mostly noninteractive second stage. Assumes
# that base-config has been preseeded to not ask for anything except for
# the root password. Ends when the system is installed and at a login
# prompt.
use strict;
use Expect;

my $exp = new Expect;
#$exp->exp_internal(1);
$exp->raw_pty(1);

my $root_pw_done=0;

$exp->spawn($ENV{CONSOLECOMMAND}) or die "cannot connect: $!\n";
$exp->expect($ENV{STAGE_2_MAX_TIME},
	[ "-re", "Root.*password:" => sub {
		sleep 1;
		$exp->send("$ENV{ROOT_PASSWORD}\r");
		$root_pw_done=1;
		exp_continue;
	}],
	[ "-re", "password.*user:" => sub {
		sleep 1;
		$exp->send("$ENV{USER_PASSWORD}\r");
		exp_continue;
	}],
	[ "ogin:" => sub {
		exit if $root_pw_done;
		exp_continue;
	}],
	[ "The Server is in Graphics Mode" => sub {
		exit;
	}],
	[ "Unable to mount root fs" => sub {
		exit 1;
	}],
	[ timeout => sub {
		print STDERR "timeout!\n";
		exit 1;
	}],
);

exit;
