#!/bin/sh
# Sets up a preseed/t/$MACHINE file based on some environment variables.
# This is mostly useful if you're netbooting and out of kernel command line
# space, and need to vary some options on a per scheme basis.
f=$DI_TESTDIR/preseed/t/$MACHINE
rm -f $f
echo "# Automatically generated for $SCHEME digress test" >> $f

if [ -n "$TASK" ]; then
	echo "d-i preseed/include string ../task/$TASK.cfg" >> $f
fi

if [ -n "$SUITE" ]; then
	echo "d-i mirror/suite string $SUITE" >> $f
fi

if [ -n "$USER" ]; then
	echo "passwd passwd/username string $USER" >> $f
	echo "passwd passwd/user-fullname string $USER" >> $f
fi

if [ -n "$HP_ILO_STAGE2_CD" ]; then
	# This is a hack, the right way to do it would be to have iLO
	# connect the virtual CD but not boot from it when booting stage2.
	# Unfortunatly, my attempts to do that so far have failed. This
	# might even be due to a d-i bug, it does not seem to load
	# usb-storage in base-config, however, even with that loaded, the
	# virtual CD does not show up. There's also a message from hotplug
	# about "Bad USB agent invocation"..
	# 
	# So the hack is to preseed base-config to wget the whole cd image
	# and loop mount it, and make apt-setup use it as a file uri. Ugh.
	echo "base-config base-config/early_command string wget $HP_ILO_ISO_URL -O /var/tmp/install.iso; mount -o loop /var/tmp/install.iso /cdrom" >> $f
	echo "apt-setup apt-setup/uri_type select filesystem" >> $f
	echo "apt-setup apt-setup/directory string /cdrom" >> $f
fi
