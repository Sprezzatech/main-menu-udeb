#!/bin/sh -e

. /usr/share/debconf/confmodule

# The C@utf-8 locale is not usable inside /target/.  Unset it here to avoid
# warnings like 'perl: warning: Setting locale failed.'.
if [ "$LANG" = "C@utf-8" ] ; 
	unset LANG
fi

if [ ! -f /target/etc/apt/sources.list ] ; then
    # Only queue the package, it will be installed by base-installer
    # postinst.
    mkdir -p /var/lib/apt-install
    touch /var/lib/apt-install/queue
    for pkg in $@ ; do
	echo "$pkg" >> /var/lib/apt-install/queue
    done
    # Return error as the package is not ready to be used yet.
    exit 1
fi

# Try to enable proxy when using HTTP.  What about using ftp_proxy for
# FTP sources?  (This code is in both apt-update and apt-install)
# XXX Using debconf functions failed when called from base-installer and
# XXX kernel-installer
#if db_get mirror/protocol && [ "http" = "$RET" ]; then
#    # try to find http proxy
#    if db_get mirror/http/proxy && [ "$RET" ] ; then
#	http_proxy="$RET"
#	export http_proxy
#    fi
#fi

# first copy the files into /target/, then install in chroot
# environment.  This work around a bug in glibc, and make sure the
# packages run their postinst script in their target environment.

PATH=$PATH:/target/usr/bin:/target/bin:/target/usr/sbin:/target/sbin \
LD_LIBRARY_PATH=/usr/lib:/lib:/target/usr/lib:/target/lib \
/target/usr/bin/apt-get \
    -o Dir::State=/target/var/lib/apt \
    -o Dir::State::status=/target/var/lib/dpkg/status \
    -o Dir::Cache=/target/var/cache/apt \
    -o Dir::Etc=/target/etc/apt \
    -o Dir::Bin::methods=/target/usr/lib/apt/methods \
    -o Dir::Bin::gzip=/target/bin/gzip \
    -o Dir::Bin::dpkg=/target/usr/bin/dpkg \
    -o Dpkg::Options::=--root=/target \
    -y --download-only install $@

# Some packages (eg. the kernel-image package) require a mounted /proc/
# Only mount it if it isn't mounted already
if [ ! -f /target/proc/cmdline ] ; then
    mount -t proc proc /target/proc
fi

DEBIAN_FRONTEND=noninteractive \
chroot /target apt-get --no-download -y install $@ < /dev/null

umount /target/proc

exit 0
