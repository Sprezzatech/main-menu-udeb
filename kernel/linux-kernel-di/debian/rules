#!/usr/bin/make -f

ARCH=$(shell dpkg-architecture -qDEB_HOST_ARCH)
VERSION=$(shell dpkg-parsechangelog | grep ^Version: | cut -d ' ' -f 2)

links:
	./make-links

debian/control: links gen-control debian/control.stub package-list kernel-versions
	./gen-control > debian/control

build: links debian/control
	dh_testdir

clean: debian/control
	dh_testdir
	dh_clean `find modules -type l`

binary-indep:

binary-arch: links debian/control
	dh_testdir
	dh_clean -k
	
	./install-files

	dh_fixperms -s
	for p in $$(dh_listpackages -s); do \
		dh_gencontrol -p $$p -- -n$${p}_$(VERSION)_$(ARCH).udeb; \
		dh_builddeb -p $$p --filename=$${p}_$(VERSION)_$(ARCH).udeb; \
	done

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary links
