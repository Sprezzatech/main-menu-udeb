#! /bin/sh -xe

LOGDIR=/target/var/log

PROTOCOL=
MIRROR=
DIRECTORY=
COMPONENTS="main,local"
DISTRIBUTION=sarge

if [ "$1" = "configure" ]; then
    . /usr/share/debconf/confmodule

    if [ -f /cdrom/.disk/base_installable ]; then

        PROTOCOL=file
        MIRROR=""
        DIRECTORY="/cdrom/"
        if [ -s /cdrom/.disk/base_components ]; then
            COMPONENTS=`grep -v '^#' /cdrom/.disk/base_components | tr '\n' , | sed 's/,$//'`
        else
            COMPONENTS="*"
        fi

        if [ -s /cdrom/.disk/base_include ]; then
            INCLUDES=`grep -v '^#' /cdrom/.disk/base_include | tr '\n' , | sed 's/,$//'`
        fi

        if [ -s /cdrom/.disk/base_exclude ]; then
            EXCLUDES=`grep -v '^#' /cdrom/.disk/base_exclude | tr '\n' , | sed 's/,$//'`
        fi
    else

        db_get mirror/protocol
        PROTOCOL="$RET"

        db_get mirror/$PROTOCOL/hostname
        MIRROR="$RET"

        db_get mirror/$PROTOCOL/directory
        DIRECTORY="$RET"

    fi

    if db_get mirror/distribution && [ "$RET" ] ; then
	DISTRIBUTION=$RET
    fi

    if [ woody = "$DISTRIBUTION" ] ; then
        KERNEL_IMAGE=kernel-image-2.4.18-386,initrd-tools,ash,cramfsprogs,zlib1g
    else
        KERNEL_IMAGE=kernel-image-2.4.19-386,initrd-tools,dash,cramfsprogs,zlib1g
    fi

    INCLUDE=`echo "--include=${KERNEL_IMAGE},${INCLUDES}" | sed 's/,$//'`
    if [ "${EXCLUDES}" ]; then
        EXCLUDE="--exclude=${EXCLUDES}"
    else
        EXCLUDE=
    fi

    # Default hostname is 'localhost'
    HOSTNAME=localhost
    NAMES=localhost
    if db_get netcfg/get_hostname && [ "$RET" ]; then
        NAMES="$RET $NAMES"
        HOSTNAME=$RET
    fi
 
    if db_get netcfg/get_domain && [ "$RET" -a "$HOSTNAME" ] ; then
    	NAMES="${HOSTNAME}.$RET $NAMES"
    fi

    test -d /target/etc || mkdir -p /target/etc

    echo "$HOSTNAME" > /target/etc/hostname
    echo "$HOSTNAME" > /proc/sys/kernel/hostname 
    echo "127.0.0.1 $NAMES" > /target/etc/hosts

    unset DEBIAN_HAS_FRONTEND
    unset DEBIAN_FRONTEND
    unset DEBCONF_FRONTEND
    unset DEBCONF_REDIR

    # This is a hack to avoid heaps of messages like 'Note
    # /etc/modules.conf is more recent than /lib/modules/*/modules.dep'
    touch /etc/modules.conf
    depmod -a

    cat > /target/etc/kernel-img.conf <<EOF
# Do not create symbolic links in /
do_symlinks = yes

# postinst_hook =
# postrm_hook = 
do_bootloader = no
do_bootfloppy = no
do_initrd = yes
EOF

# Avoid the possibility of getting a root shell without giving passord
# when booting the 2.4 kernel
# This must be done after initrd-tools is installed, but before the
# kernel is installed.
#cat >> /target/etc/mkinitrd/mkinitrd.conf <<EOF
#DELAY=0
#EOF

    test -d $LOGDIR || mkdir -p $LOGDIR

    # Make lilo not try to install itself
    echo "# UNCONFIGURED FSTAB FOR BASE SYSTEM" >> /target/etc/fstab

    debootstrap \
	--components="${COMPONENTS}" \
	--boot-floppies ${INCLUDE} \
	${EXCLUDE} ${DISTRIBUTION} /target \
	${PROTOCOL}://${MIRROR}${DIRECTORY} \
	3>&1 > $LOGDIR/debootstrap.log \
	2> $LOGDIR/debootstrap.err.log </dev/null

    # Make lilo not try to install itself
    grep -v "# UNCONFIGURED FSTAB FOR BASE SYSTEM" < /target/etc/fstab > /target/etc/fstab.new
    mv /target/etc/fstab.new /target/etc/fstab

fi
exit 0
