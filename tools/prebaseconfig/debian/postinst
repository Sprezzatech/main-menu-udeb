#! /bin/sh -e

ARCH=`udpkg --print-architecture`

. /usr/share/debconf/confmodule

if db_get debian-installer/profile && [ "$RET" ]; then
	PROFILE=$RET
else
	PROFILE=Workstation
fi

if db_get debian-installer/locale && [ "$RET" ] ; then
    LANG_INST="$RET"
fi

# Default hostname is 'localhost'
HOSTNAME=localhost
NAMES=localhost
if db_get netcfg/get_hostname && [ "$RET" ]; then
    NAMES="$RET $NAMES"
    HOSTNAME=$RET
fi
 
if db_get netcfg/get_domain && [ "$RET" -a "$HOSTNAME" ] ; then
    NAMES="${HOSTNAME}.$RET $NAMES"
fi

echo "$HOSTNAME" > /target/etc/hostname
echo "127.0.0.1 $NAMES" > /target/etc/hosts

interfaces=/target/etc/network/interfaces

# Every host need the loopback interface
cat > $interfaces <<EOF
# /etc/network/interfaces -- configuration file for ifup(8), ifdown(8)

# The loopback interface
auto lo
iface lo inet loopback

EOF

# Should it get the information from the netcfg package instead?
  
# Hm, what if both server and workstation is choosen?  Choose the
# server config for eth0.
for value in `echo $PROFILE |sed 's/ /-/g' | sed 's/,-/ /g'`; do
    case $value in
	Workstation)
 	    # Use this unless Server also was choosen.
	    if [ -z "$eth0" ] ; then
		eth0=dhcp
	    fi
	    ;;
	Server)
	    # Override for workstations combining as servers
	    eth0=10.0.2.2
	    ;;
	LTSP-server)
	    eth1=192.168.0.254
	    ;;
     esac
done
  
for interface in eth0 eth1 ; do
    eval "ifinfo=\$$interface"
    case $ifinfo in
	dhcp)
	    cat >> $interfaces <<EOF

# This entry was created during the Debian installation
auto $interface
iface $interface inet dhcp
EOF

	    ;;
	[0-9]*)
	    cat >> $interfaces <<EOF

# This entry was created during the Debian installation
auto $interface
iface $interface inet static
    address $ifinfo
    netmask 255.255.254.0
  
# The commented lines below is to be used if a DHCP server is in use
#auto $interface
#iface $interface inet dhcp
EOF
	    ;;
	*)
	    # Nothing to do?
	    ;;
    esac
done

# Copy install logs to /target/var/log/
logsavedir=/target/var/log/debian-installer
test -d $logsavedir || mkdir $logsavedir
cp /var/log/* $logsavedir

# Copy current debconf databse into /target
cp -a /var/lib/cdebconf /target/root

# Look in /proc/cmdline for console=ttyS*, indicating a serial console
# and fix inittab if so.
console=$( echo " " $( cat /proc/cmdline ) " " | sed -n 's/^.* console=\([^ ]*\) .*$/\1/p' )
# XXX limited to hppa so far, until tested elsewhere
if [ "$ARCH" = "hppa" ] && ( echo "$console" | grep -q "^ttyS" )
then
    # serial console, fix inittab and /etc/securetty.  This edits the
    # ttyS0 entry for whichever ttySn is used, rather than trying to
    # enable the right one.  Allows for ttySn for n>1 that way.
    ttyspeed=$( echo "$console" | sed -n 's/^[^,]*,\([0-9]\+\).*$/\1/p' )
    ttyname=$( echo "$console" | sed 's/,.*//' )
    ttyline=$( echo "$ttyname" | sed 's/^ttyS//' )
    ttyterm=$TERM
    [ -z "$ttyterm" ] && ttyterm=vt100
    [ -z "$ttyspeed" ] && ttyspeed=9600
    cat /target/etc/inittab | sed \
        -e "s/^\([1-6]\):/#\1:/" \
	-e "s/^#T0\(.*ttyS\).*/T$ttyline\1$ttyline $ttyspeed $ttyterm/" \
            > /target/etc/inittab.real
    echo "# $ttyname added by debian-installer" >> /target/etc/securetty
    echo "$ttyname" >> /target/etc/securetty
else
    # graphical console, leave inittab alone
    mv /target/etc/inittab /target/etc/inittab.real
fi

# Prepare to run base-config after reboot
cp /usr/share/prebaseconfig/inittab /target/etc/inittab
(
    echo LANG_INST="$LANG_INST"
) >> /target/root/dbootstrap_settings

# Throw out the CD if installing from CD.
cdromdev=/dev/cdroms/0
eject $cdromdev || /target/usr/bin/eject $cdromdev || true

# Install the installation report template
cp /usr/share/prebaseconfig/install-report.template /target/root

# run-parts is part of debianutils, is it available in d-i? [pere 2002-11-02]
if /target/bin/run-parts --report /usr/lib/prebaseconfig.d ; then
    :
else
    echo "error: run-parts failed.  Using shell script loop instead." 1>&2
    # Using this until run-parts is available.
    for f in /usr/lib/prebaseconfig.d/*; do
        if [ -x $f ] ; then
            $f || true
        else
            echo "error: Unable to execute $f" 1>&2
        fi
    done
fi

umount -a || true

/sbin/reboot

db_fset prebaseconfig/reboot_in_progress seen false || true
db_input critical prebaseconfig/reboot_in_progress || true
db_go || true
