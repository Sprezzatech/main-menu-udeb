#! /bin/sh

set -e

log() {
    logger -t prebaseconfig "$@"
}

# Use this instead of /target/bin/run-parts because one of the
# parts will unmount /target/
run_parts() {
    partsdir="$1"
    tmpfile=/tmp/prebaseconfig.stderr.log
    for script in "$partsdir"/*; do
        if [ -x "$script" ] ; then
            log "info: Running $script"
            if "$script" 2> $tmpfile ; then
		:
	    else
		log "warning: $script returned error code $?"
	    fi
	    if [ -s "$tmpfile" ] ; then
		logger -t prebaseconfig < "$tmpfile"
	    fi
	    rm -f "$tmpfile"
        else
            log "error: Unable to execute $script"
        fi
    done
}

run_parts /usr/lib/prebaseconfig.d
