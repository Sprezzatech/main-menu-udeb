#! /bin/sh

. /usr/share/debconf/confmodule

set -e

log() {
    logger -t prebaseconfig "$@"
}

# Use this instead of /target/bin/run-parts because one of the
# parts will unmount /target/
run_parts() {
    partsdir="$1"
    scriptcount=`ls "$partsdir"/* | wc -l`

    db_progress START 0 $scriptcount prebaseconfig/runparts-progress/title

    tmpfile=/tmp/prebaseconfig.stderr.log
    for script in "$partsdir"/*; do

	db_subst prebaseconfig/runparts-progress/step SCRIPT "$script"
	db_progress INFO prebaseconfig/runparts-progress/step

        if [ -x "$script" ] ; then
            log "info: Running $script"
            if "$script" 2> $tmpfile ; then
		:
	    else
		log "warning: $script returned error code $?"
	    fi
	    if [ -s "$tmpfile" ] ; then
		logger -t prebaseconfig < "$tmpfile"
	    fi
	    rm -f "$tmpfile"
        else
            log "error: Unable to execute $script"
        fi

	db_progress STEP 1
    done
    db_progress STOP
}

run_parts /usr/lib/prebaseconfig.d
