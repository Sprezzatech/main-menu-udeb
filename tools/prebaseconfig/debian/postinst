#! /bin/sh -e

. /usr/share/debconf/confmodule

db_get debian-installer/profile || true
if [ "$RET" ]; then
	PROFILE=$RET
else
	PROFILE=Workstation
fi

db_get debian-installer/locale || true
LANG_INST="$RET"

db_get netcfg/get_hostname 
HOSTNAME=$RET

db_get netcfg/get_domain
FQDN=${HOSTNAME}.$RET

echo "$HOSTNAME" > /target/etc/hostname
echo "127.0.0.1 $FQDN $HOSTNAME localhost" > /target/etc/hosts

interfaces=/target/etc/network/interfaces

# Every host need the loopback interface
cat > $interfaces <<EOF
# /etc/network/interfaces -- configuration file for ifup(8), ifdown(8)

# The loopback interface
auto lo
iface lo inet loopback

EOF

# Should it get the information from the netcfg package instead?
  
# Hm, what if both server and workstation is choosen?  Choose the
# server config for eth0.
for value in `echo $PROFILE |sed 's/ /-/g' | sed 's/,-/ /g'`; do
    case $value in
	Workstation)
 	    # Use this unless Server also was choosen.
	    if test -z "$eth0" then
		eth0=dhcp
	    fi
	    ;;
	Server)
	    # Override for workstations combining as servers
	    eth0=10.0.2.2
	    ;;
	LTSP-server)
	    eth1=192.168.0.254
	    ;;
     esac
done
  
for interface in eth0 eth1 ; do
    eval "ifinfo=\$$interface"
    case $ifinfo in
	dhcp)
	    cat >> $interfaces <<EOF

# This entry was created during the Debian installation
auto $interface
iface $interface inet dhcp
EOF

	    ;;
	[0-9]*)
	    cat >> $interfaces <<EOF

# This entry was created during the Debian installation
auto $interface
iface $interface inet static
    address $ifinfo
    netmask 255.255.254.0
  
# The commented lines below is to be used if a DHCP server is in use
#auto $interface
#iface $interface inet dhcp
EOF
	    ;;
	*)
	    # Nothing to do?
	    ;;
    esac
done

# This is handled by {grub,lilo}-installer
# chroot /target /sbin/grub-install '(hd0)'
# Pipe from 'yes' to tell grub to create menu.lst when it is missing
# chroot /target /usr/bin/yes | chroot /target /sbin/update-grub

# Copy install logs to /target/var/log/
logsavedir=/target/var/log/debian-installer
test -d $logsavedir || mkdir $logsavedir
cp /var/log/* $logsavedir

# Copy current debconf databse into /target
cp -a /var/lib/cdebconf /target/root

# Prepare to run base-config after reboot
mv /target/etc/inittab /target/etc/inittab.real
cp /usr/share/prebaseconfig/inittab /target/etc/inittab
(
    echo LANG_INST="$LANG_INST"
) >> /target/root/dbootstrap_settings

umount -a || true

# Throw out the CD if installing from CD.
eject || true

/sbin/reboot
