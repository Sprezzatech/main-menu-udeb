#! /bin/sh -e

. /usr/share/debconf/confmodule

if db_get debian-installer/profile && [ "$RET" ]; then
	PROFILE=$RET
else
	PROFILE=Workstation
fi

if db_get debian-installer/locale && [ "$RET" ] ; then
    LANG_INST="$RET"
fi

# Default hostname is 'localhost'
HOSTNAME=localhost
NAMES=localhost
if db_get netcfg/get_hostname && [ "$RET" ]; then
    NAMES="$RET $NAMES"
    HOSTNAME=$RET
fi
 
if db_get netcfg/get_domain && [ "$RET" -a "$HOSTNAME" ] ; then
    NAMES="${HOSTNAME}.$RET $NAMES"
fi

echo "$HOSTNAME" > /target/etc/hostname
echo "127.0.0.1 $NAMES" > /target/etc/hosts

interfaces=/target/etc/network/interfaces

# Every host need the loopback interface
cat > $interfaces <<EOF
# /etc/network/interfaces -- configuration file for ifup(8), ifdown(8)

# The loopback interface
auto lo
iface lo inet loopback

EOF

# Should it get the information from the netcfg package instead?
  
# Hm, what if both server and workstation is choosen?  Choose the
# server config for eth0.
for value in `echo $PROFILE |sed 's/ /-/g' | sed 's/,-/ /g'`; do
    case $value in
	Workstation)
 	    # Use this unless Server also was choosen.
	    if [ -z "$eth0" ] ; then
		eth0=dhcp
	    fi
	    ;;
	Server)
	    # Override for workstations combining as servers
	    eth0=10.0.2.2
	    ;;
	LTSP-server)
	    eth1=192.168.0.254
	    ;;
     esac
done
  
for interface in eth0 eth1 ; do
    eval "ifinfo=\$$interface"
    case $ifinfo in
	dhcp)
	    cat >> $interfaces <<EOF

# This entry was created during the Debian installation
auto $interface
iface $interface inet dhcp
EOF

	    ;;
	[0-9]*)
	    cat >> $interfaces <<EOF

# This entry was created during the Debian installation
auto $interface
iface $interface inet static
    address $ifinfo
    netmask 255.255.254.0
  
# The commented lines below is to be used if a DHCP server is in use
#auto $interface
#iface $interface inet dhcp
EOF
	    ;;
	*)
	    # Nothing to do?
	    ;;
    esac
done

# Copy install logs to /target/var/log/
logsavedir=/target/var/log/debian-installer
test -d $logsavedir || mkdir $logsavedir
cp /var/log/* $logsavedir

# Copy current debconf databse into /target
cp -a /var/lib/cdebconf /target/root

# Prepare to run base-config after reboot
mv /target/etc/inittab /target/etc/inittab.real
cp /usr/share/prebaseconfig/inittab /target/etc/inittab
(
    echo LANG_INST="$LANG_INST"
) >> /target/root/dbootstrap_settings

# Throw out the CD if installing from CD.
eject || /target/usr/bin/eject || true

# run-parts is part of debianutils, is it available in d-i? [pere 2002-11-02]
if /target/bin/run-parts --report /usr/lib/prebaseconfig.d ; then
    :
else
    echo "error: run-parts failed.  Using shell script loop instead." 1>&2
    # Using this until run-parts is available.
    for f in /usr/lib/prebaseconfig.d/*; do
        if [ -x $f ] ; then
            $f || true
        else
            echo "error: Unable to execute $f" 1>&2
        fi
    done
fi

umount -a || true

/sbin/reboot

db_fset prebaseconfig/reboot_in_progress seen false || true
db_input critical prebaseconfig/reboot_in_progress || true
db_go || true
