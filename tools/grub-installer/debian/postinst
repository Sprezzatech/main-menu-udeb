#! /bin/sh -e
export LD_LIBRARY_PATH="/target/lib:/target/usr/lib"

. /usr/share/debconf/confmodule

if [ "$defaultbootdev" ] ; then
    db_subst grub-installer/bootdev bootdev "$defaultbootdev"
fi
db_input medium grub-installer/bootdev || true
db_go || true

db_get grub-installer/bootdev
bootdev=$RET

chroot /target /sbin/grub-install "$bootdev"

# Pipe from 'yes' to tell grub to create menu.lst when it is missing
# A better correct fix is to get update-grub to be able to run
# in noninteractive mode
chroot /target /usr/bin/yes | chroot /target /sbin/update-grub

IMG_CONF=/target/etc/kernel-img.conf
/target/bin/echo "postinst_hook = /sbin/update-grub" >> $IMG_CONF
/target/bin/echo "postrm_hook   = /sbin/update-grub" >> $IMG_CONF
/target/bin/echo "do_bootloader = no" >> $IMG_CONF
