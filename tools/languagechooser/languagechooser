#!/bin/sh -e

. /usr/share/debconf/confmodule

logfile=/var/log/messages

localecode="debian-installer/locale"
languagecode="debian-installer/language"
languagenamecode="debian-installer/language-name"
countrycode="debian-installer/country"
countrynamecode="debian-installer/country-name"

log() {
  echo "languagechooser: info: $*" >> $logfile
}

db_capb backup

STATE=1

while [ "$STATE" -gt 0 ]; do
case "$STATE" in
  1)
    db_fset "$languagenamecode" seen false
    db_input critical "$languagenamecode" || [ $? -eq 30 ]
    if db_go; then
        db_get "$languagenamecode"
        language=`echo $RET | sed -e 's/ .*//'`
        db_set "$languagecode" "$language"
        STATE=$(($STATE + 1))
    else
        STATE=$(($STATE - 1))
    fi
    ;;

  2)
    db_fset "$countrynamecode" seen false
    db_input critical "$countrynamecode" || [ $? -eq 30 ]
    if db_go; then
        db_get "$countrynamecode"
        if [ "$RET" != "Other" ]; then
            country=`echo $RET | sed -e 's/ .*//'`
            db_set "$countrycode" "$country"
        fi
        STATE=$(($STATE + 1))
    else
        STATE=$(($STATE - 1))
    fi
    ;;

  3)
    db_fset "$localecode" seen false
    db_input critical "$localecode" || [ $? -eq 30 ]
    if db_go; then
        db_get "$localecode"
        locale="$RET"
        STATE=$(($STATE + 1))
    else
        STATE=$(($STATE - 1))
    fi
    ;;
  *)
    STATE=-1
    ;;
esac
done

[ $STATE = -1 ] || exit 0

log "debian-installer/locale   = '$locale'"
log "debian-installer/language = '$language'"
log "debian-installer/country  = '$country'"
