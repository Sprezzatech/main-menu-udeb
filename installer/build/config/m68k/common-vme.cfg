
M68K_NETBOOT_VME = $(SOME_DEST)/$(EXTRANAME)tftplilo.conf $(SOME_DEST)/$(EXTRANAME)tftplilo.txt $(SOME_DEST)/$(EXTRANAME)tftplilo.bvme $(SOME_DEST)/$(EXTRANAME)tftplilo.mvme

$(SOME_DEST)/$(EXTRANAME)tftplilo.conf: boot/m68k/vme-tftplilo.conf
	cp $< $@
	./update-manifest $@ $(MANIFEST-CONFIG)

$(SOME_DEST)/$(EXTRANAME)tftplilo.txt: boot/m68k/vme-tftplilo.txt
	cp $< $@
	./update-manifest $@ $(MANIFEST-DOCS)

$(SOME_DEST)/$(EXTRANAME)tftplilo.bvme: /boot/tftplilo.bvme
	cp $< $@
	./update-manifest $@ $(MANIFEST-TFTP-B)

$(SOME_DEST)/$(EXTRANAME)tftplilo.mvme: /boot/tftplilo.mvme
	cp $< $@
	./update-manifest $@ $(MANIFEST-TFTP-M)

.PHONY: arch_boot_screens
arch_boot_screens:

.PHONY: arch_boot_floppy
arch_boot_floppy: 
	$(shell mkdir -p $(TREE)boot/etc)
	$(shell cp boot/m68k/vme-vmelilo.conf-floppy $(TREE)boot/etc/vmelilo.conf)
	$(shell cp $(shell echo $(TEMP_KERNEL) | cut -d' ' -f 1) $(TREE)boot/linux)
	$(shell ./makelabel $(DISK_LABEL) $(BUILD_DATE) > $(TREE)boot/disk.lbl)
	$(shell genext2fs -d $(TREE)boot -b $(FLOPPY_SIZE) -r 0 $(TEMP_BOOT))
	$(shell $(ROOTCMD) mount -t ext2 -o loop $(TEMP_BOOT) $(TREE)boot)
	LOOPDEV := $(shell mount | grep -i $(TREE)boot | perl -ne 'm|.*loop=(/dev/loop[0-9]+)| && print $1;')
	$(warning loopdev $(LOOPDEV))
	RETVAL := $(shell $(ROOTCMD) vmelilo -f -a $(M68K_VMEARCH) -b /dev/null -w $(TREE)boot -d $(LOOPDEV))
	$(ROOTCMD) umount $(TREE)boot
	ifneq ( $(RETVAL), 0 ) $(error vmelilo failed)
	$(if $(GZIPPED),gzip -v9f $(TEMP_BOOT))

.PHONY: arch_root
arch_root: 
	mkdir -p $(TEMP)/root/etc
	cp $(TEMP_INITRD) $(TEMP)/root/root.bin
	./makelabel $(DISK_LABEL) $(BUILD_DATE) > $(TEMP)/root/disk.lbl
	genext2fs -d $(TEMP)/root -b $(FLOPPY_SIZE) -r 0 $(TEMP_ROOT)
	$(e2fsck) $(TEMP_ROOT) || true 
	$(if $(GZIPPED),gzip -v9f $(TEMP_ROOT))

.PHONY: arch_boot
arch_boot:  /proc/mounts
	mkdir -p $(TEMP)/boot/etc
	mkdir -p $(TEMP)/boot/boot
	mkdir -p $(TEMP)/mount
	cp $(shell echo $(TEMP_KERNEL) | cut -d' ' -f 1) $(TEMP)/boot/linux
	if [ "$(FLOPPY_SIZE)" = "2880" ]; then \
		cp $(TEMP_INITRD) $(TEMP)/boot/root.bin ; \
		cp boot/m68k/vme-vmelilo.conf-cdfloppy $(TEMP)/boot/etc/vmelilo.conf ; \
	else \
		cp boot/m68k/vme-vmelilo.conf-floppy $(TEMP)/boot/etc/vmelilo.conf ; \
	fi ;
	./makelabel $(DISK_LABEL) $(BUILD_DATE) > $(TEMP)/boot/disk.lbl
	genext2fs -d $(TEMP)/boot -b $(FLOPPY_SIZE) -r 0 $(TEMP_BOOT)
	$(ROOTCMD) mount -t ext2 -o loop=/dev/loop3 $(TEMP_BOOT) $(TEMP)/mount
	@echo loopdev $(shell grep $(TEMP)/mount /proc/mounts | cut -d' ' -f 1)
	if $(ROOTCMD) vmelilo -f -a $(M68K_VMEARCH) -b /dev/null -w $(TEMP)/mount \
			-d /dev/loop3 ; then \
		$(ROOTCMD) umount $(TEMP)/mount ; \
		$(e2fsck) $(TEMP_BOOT) || true ; \
		$(if $(GZIPPED),gzip -v9f $(TEMP_BOOT)) ; \
	else \
		echo "vmelilo failed, moving boot.img ..." ; \
		$(ROOTCMD) umount $(TEMP)/mount ; \
		mv $(TEMP_BOOT) $(TEMP_BOOT).failed ; \
	fi ;

