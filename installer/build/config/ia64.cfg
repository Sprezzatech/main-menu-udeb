# How big a floppy image should I make? (in kilobytes)
#FLOPPY_SIZE = 10240
FLOPPY_SIZE = 20480

MEDIUM_SUPPORTED = cdrom netboot miniiso

# The version of the kernel to use.
KERNELMAJOR = 2.4
KERNELVERSION = 2.4.26-itanium-smp
KERNELVERSION_2.6 = 2.6.7-1-itanium-smp
KERNEL_FLAVOUR = di
KERNELNAME = vmlinuz
KERNELIMAGEVERSION = $(KERNELVERSION)

# The DOS volume id to use for DOS floppies. This is a 32 bit hexidecimal
# number.
DOS_VOLUME_ID = deb00001
# The DOS volume label to use for DOS floppies. This is a 11 character
# string.
DOS_VOLUME_LABEL = "Debian Inst"

# Create a bootable floppy image.
# 1. make a dos filesystem image
# 2. copy over kernel, initrd
# 3. copy over elilo files
.PHONY: arch_boot
arch_boot:
	dd if=/dev/zero of=$@.new bs=1k count=$(FLOPPY_SIZE)
	mkfs.msdos -i $(DOS_VOLUME_ID) -n $(DOS_VOLUME_LABEL) -C $(TEMP_BOOT) $(FLOPPY_SIZE)

	mmd -i$(TEMP_BOOT) ::/efi
	mmd -i$(TEMP_BOOT) ::/efi/boot
	mcopy -i$(TEMP_BOOT) $(TEMP_KERNEL) ::/linux
	mcopy -i$(TEMP_BOOT) $(TEMP_INITRD) ::/initrd.gz
	if [ -n "$(KERNEL_2.6)" ] && [ -n "$(INITRD_2.6)" ]; then \
		mcopy -i$(TEMP_BOOT) $(KERNEL_2.6) ::/linux26; \
		mcopy -i$(TEMP_BOOT) $(INITRD_2.6) ::/initrd26.gz; \
	fi
	mcopy -i$(TEMP_BOOT) /usr/lib/elilo/elilo.efi ::/efi/boot/bootia64.efi
	mcopy -i$(TEMP_BOOT) /usr/lib/elilo/elilo.efi ::/elilo.efi
	mcopy -i$(TEMP_BOOT) $(TEMP_BOOT_SCREENS)/elilo-cd.conf ::/elilo.conf
	mcopy -i$(TEMP_BOOT) $(TEMP_BOOT_SCREENS)/elilo-cd.conf ::/efi/boot/elilo.conf
	mcopy -i$(TEMP_BOOT) $(TEMP_BOOT_SCREENS)/elilo_menu.msg ::/efi/boot/elilo_menu.msg
	mcopy -i$(TEMP_BOOT) boot/ia64/general.msg ::/efi/boot/general.msg
	mcopy -i$(TEMP_BOOT) boot/ia64/params.msg ::/efi/boot/params.msg
	echo "elilo linux" | mcopy -i$(TEMP_BOOT) - ::/install.nsh

.PHONY: arch_boot_screens
arch_boot_screens:
	-rm -f $(TEMP_BOOT_SCREENS)/*
	mkdir -p $(TEMP_BOOT_SCREENS)
	cat boot/ia64/elilo_menu.msg | ./bootscreen-subst "$(MEDIA_TYPE)" \
		"$(DEBIAN_VERSION)" "$(BUILD_DATE)" \
		 > $(TEMP_BOOT_SCREENS)/elilo_menu.msg
	(if [ -n "$(INITRD_2.6)" ] && [ -n "$(KERNEL_2.6)" ]; then \
		cat boot/ia64/elilo-cd.conf.with26; \
	else \
		cat boot/ia64/elilo-cd.conf; \
	fi) \
	| ./ramdisk-size-subst $(TEMP_INITRD) $(INITRD_2.6) \
		> $(TEMP_BOOT_SCREENS)/elilo-cd.conf
	
.PHONY: arch_miniiso
arch_miniiso:
	-rm -rf $(TEMP_CD_TREE)/*
	install -m 644 -D $(BASE_TMP)miniiso/boot.img \
		$(TEMP_CD_TREE)/boot/boot.img

	mkisofs -no-emul-boot -J -o $(TEMP_MINIISO) -b boot/boot.img \
		-c boot/boot.catalog $(TEMP_CD_TREE)
