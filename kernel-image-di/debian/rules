#!/usr/bin/make -f

# Kernel version.
KVERS=2.4.0
# Kenrel flavor.
FLAVOUR=di

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This is the debhelper compatability version to use.
export DH_COMPAT=2

PRIORITY=$(shell grep ^Priority: debian/control | cut -d ' ' -f 2)
VERSION=$(shell dpkg-parsechangelog | grep ^Version: | cut -d ' ' -f 2)
ARCH=$(shell dpkg --print-architecture)

# Unpack the source (which we build-depend on).
unpack: unpack-stamp
unpack-stamp:
	tar xf /usr/src/kernel-source-$(KVERS).tar.bz2 --bzip2
	touch unpack-stamp

# Use kernel-package to do the actual building.
build: unpack build-stamp
build-stamp:
	mkdir -p kernel-source-$(KVERS)/debian
	./make-kernel-control $(KVERS) $(FLAVOUR) \
		kernel-source-$(KVERS)/debian/control
	cp debian/changelog kernel-source-$(KVERS)/debian
	echo official > kernel-source-$(KVERS)/debian/official
	cp config kernel-source-$(KVERS)/.config
	# Hack up the Makefile for flavour support.
	cd kernel-source-$(KVERS); \
		if [ ! -e Makefile.orig ]; then \
			cp Makefile Makefile.orig; \
		fi; \
		sed 's/^\(KERNELRELEASE=.*\)$$/\1-$$(FLAVOUR)/' Makefile.orig > Makefile; \
		make-kpkg --flavour di build
	touch build-stamp

clean:
	rm -f build-stamp unpack-stamp
	-rm -rf kernel-source-$(KVERS)
	-dh_clean
	-mv -f debian/control.orig debian/control
	dh_clean

# Use kernel-package to build the kernel image.
binary-image: build
	cd kernel-source-$(KVERS); \
		CLEAN_SOURCE=no make-kpkg --flavour di kernel-image
	cat kernel-source-$(KVERS)/debian/files >> debian/files
	mv *.deb ..

# Build module udebs. Skip processing the kernel image deb.
export DH_OPTIONS=
binary-udebs: DH_OPTIONS=-Nkernel-image-$(KVERS)-$(FLAVOUR)
binary-udebs: build
	dh_testversion 2.1.18
	dh_testdir
	dh_testroot
	
	cd kernel-source-$(KVERS); \
		FLAVOUR=di make INSTALL_MOD_PATH=`pwd`/modules modules_install
	# Actually installs all the modules into place, and
	# generates debian/control.out.
	./copy-modules kernel-source-$(KVERS)/modules $(KVERS) $(FLAVOUR)
	if [ ! -e debian/control.orig ]; then \
		mv -f debian/control debian/control.orig; \
	fi
	mv -f debian/control.out debian/control
	
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_shlibdeps
	# Don't write your stupid guesses to debian/files.
	dh_gencontrol -- -fdebian/files~
	# Register udebs manually and build udebs.
	for package in `dh_listpackages`; do \
		dpkg-distaddfile $${package}_$(VERSION)_$(ARCH).udeb \
			admin $(PRIORITY); \
		dh_builddeb --package=$${package} \
			--filename=$${package}_$(VERSION)_$(ARCH).udeb; \
	done

binary-arch: binary-image binary-udebs
binary-indep:

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install unpack
